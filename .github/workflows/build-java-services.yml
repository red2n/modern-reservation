name: Build Java Services

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'apps/backend/java-services/**'
      - 'libs/shared/backend-utils/**'
      - '.github/workflows/build-java-services.yml'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'apps/backend/java-services/**'
      - 'libs/shared/backend-utils/**'
      - '.github/workflows/build-java-services.yml'
  workflow_dispatch:

jobs:
  build:
    name: Build and Test Java Services
    runs-on: ubuntu-latest

    strategy:
      matrix:
        java-version: [21]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ“¦ Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ğŸ” Verify Maven installation
        run: mvn --version

      - name: ğŸ” Verify Project Structure
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifying Project Structure"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Parent POM:"
          ls -la apps/backend/java-services/pom.xml
          echo ""
          echo "Backend Utils:"
          ls -la libs/shared/backend-utils/pom.xml
          echo ""
          echo "Infrastructure Services:"
          ls -d apps/backend/java-services/infrastructure/*/
          echo ""
          echo "Business Services:"
          ls -d apps/backend/java-services/business-services/*/
          echo ""

      - name: ğŸ—ï¸ Install Parent POM
        working-directory: apps/backend/java-services
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Installing Parent POM"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if mvn clean install -N -DskipTests; then
            echo "âœ… Parent POM installed successfully"
          else
            echo "âŒ Parent POM installation failed!"
            echo "This is critical - all services depend on the parent POM"
            exit 1
          fi

      - name: ğŸ—ï¸ Build Shared Backend Utils
        working-directory: libs/shared/backend-utils
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Building Shared Backend Utils"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if mvn clean install -DskipTests; then
            echo "âœ… Backend utils built successfully"
          else
            echo "âŒ Backend utils build failed!"
            echo "This is critical - all services depend on backend-utils"
            exit 1
          fi

      - name: ğŸ—ï¸ Build Infrastructure Services
        working-directory: apps/backend/java-services/infrastructure
        run: |
          echo "Building infrastructure services..."
          FAILED=0

          # Config Server
          if [ -d "config-server" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Config Server..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd config-server
            if mvn clean package -DskipTests; then
              echo "âœ… Config Server built successfully"
            else
              echo "âŒ Config Server build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Eureka Server
          if [ -d "eureka-server" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Eureka Server..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd eureka-server
            if mvn clean package -DskipTests; then
              echo "âœ… Eureka Server built successfully"
            else
              echo "âŒ Eureka Server build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Gateway Service
          if [ -d "gateway-service" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Gateway Service..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd gateway-service
            if mvn clean package -DskipTests; then
              echo "âœ… Gateway Service built successfully"
            else
              echo "âŒ Gateway Service build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          if [ $FAILED -gt 0 ]; then
            echo "âŒ $FAILED infrastructure service(s) failed to build"
            exit 1
          fi

          echo "âœ… All infrastructure services built successfully"

      - name: ğŸ—ï¸ Build Business Services
        working-directory: apps/backend/java-services/business-services
        run: |
          echo "Building business services..."
          FAILED=0

          # Reservation Engine
          if [ -d "reservation-engine" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Reservation Engine..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd reservation-engine
            if mvn clean package -DskipTests; then
              echo "âœ… Reservation Engine built successfully"
            else
              echo "âŒ Reservation Engine build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Payment Processor
          if [ -d "payment-processor" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Payment Processor..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd payment-processor
            if mvn clean package -DskipTests; then
              echo "âœ… Payment Processor built successfully"
            else
              echo "âŒ Payment Processor build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Rate Management
          if [ -d "rate-management" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Rate Management..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd rate-management
            if mvn clean package -DskipTests; then
              echo "âœ… Rate Management built successfully"
            else
              echo "âŒ Rate Management build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Availability Calculator
          if [ -d "availability-calculator" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Availability Calculator..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd availability-calculator
            if mvn clean package -DskipTests; then
              echo "âœ… Availability Calculator built successfully"
            else
              echo "âŒ Availability Calculator build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Analytics Engine
          if [ -d "analytics-engine" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Analytics Engine..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd analytics-engine
            if mvn clean package -DskipTests; then
              echo "âœ… Analytics Engine built successfully"
            else
              echo "âŒ Analytics Engine build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          # Batch Processor (if implemented)
          if [ -d "batch-processor" ] && [ -f "batch-processor/pom.xml" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Building Batch Processor..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            cd batch-processor
            if mvn clean package -DskipTests; then
              echo "âœ… Batch Processor built successfully"
            else
              echo "âŒ Batch Processor build failed"
              FAILED=$((FAILED + 1))
            fi
            cd ..
            echo ""
          fi

          if [ $FAILED -gt 0 ]; then
            echo "âŒ $FAILED business service(s) failed to build"
            exit 1
          fi

          echo "âœ… All business services built successfully"

      - name: ğŸ§ª Run Tests
        working-directory: apps/backend/java-services
        run: |
          echo "Running tests for all services..."

          # Test Infrastructure Services
          cd infrastructure
          for service in config-server eureka-server gateway-service; do
            if [ -d "$service" ] && [ -f "$service/pom.xml" ]; then
              echo "Testing $service..."
              cd "$service"
              mvn test || echo "âš ï¸  Tests failed for $service"
              cd ..
            fi
          done
          cd ..

          # Test Business Services
          cd business-services
          for service in reservation-engine payment-processor rate-management availability-calculator analytics-engine; do
            if [ -d "$service" ] && [ -f "$service/pom.xml" ]; then
              echo "Testing $service..."
              cd "$service"
              mvn test || echo "âš ï¸  Tests failed for $service"
              cd ..
            fi
          done

      - name: ğŸ“Š Generate Build Report
        if: always()
        run: |
          echo "## ğŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for service in config-server eureka-server gateway-service; do
            JAR_COUNT=$(find apps/backend/java-services/infrastructure/$service/target -name "*.jar" -not -name "*-javadoc.jar" -not -name "*-sources.jar" 2>/dev/null | wc -l)
            if [ "$JAR_COUNT" -gt 0 ]; then
              JAR_FILE=$(find apps/backend/java-services/infrastructure/$service/target -name "*.jar" -not -name "*-javadoc.jar" -not -name "*-sources.jar" 2>/dev/null | head -1 | xargs basename)
              echo "- âœ… **$service**: Built successfully (\`$JAR_FILE\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ **$service**: Build failed (no JAR found)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Business Services" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for service in reservation-engine payment-processor rate-management availability-calculator analytics-engine; do
            JAR_COUNT=$(find apps/backend/java-services/business-services/$service/target -name "*.jar" -not -name "*-javadoc.jar" -not -name "*-sources.jar" 2>/dev/null | wc -l)
            if [ "$JAR_COUNT" -gt 0 ]; then
              JAR_FILE=$(find apps/backend/java-services/business-services/$service/target -name "*.jar" -not -name "*-javadoc.jar" -not -name "*-sources.jar" 2>/dev/null | head -1 | xargs basename)
              echo "- âœ… **$service**: Built successfully (\`$JAR_FILE\`)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âŒ **$service**: Build failed (no JAR found)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Build completed at $(date)*" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: java-services-jars-${{ github.sha }}
          path: |
            apps/backend/java-services/infrastructure/*/target/*.jar
            apps/backend/java-services/business-services/*/target/*.jar
            !apps/backend/java-services/**/target/*-javadoc.jar
            !apps/backend/java-services/**/target/*-sources.jar
          retention-days: 7

      - name: ğŸ“Š Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-${{ github.sha }}
          path: |
            apps/backend/java-services/infrastructure/*/target/surefire-reports
            apps/backend/java-services/business-services/*/target/surefire-reports
          retention-days: 7

      - name: âœ… Build Status
        if: success()
        run: |
          echo "âœ… All Java services built successfully!"
          echo "ğŸ“¦ Artifacts uploaded"

      - name: ğŸ” Debug: List Build Artifacts
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Checking for built JAR files..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Infrastructure Services:"
          find apps/backend/java-services/infrastructure -name "*.jar" -type f 2>/dev/null || echo "No JARs found"
          echo ""
          echo "Business Services:"
          find apps/backend/java-services/business-services -name "*.jar" -type f 2>/dev/null || echo "No JARs found"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Checking Maven repository..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ls -la ~/.m2/repository/com/modernreservation/ 2>/dev/null || echo "No artifacts in Maven repo"

      - name: âŒ Build Failed
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ BUILD FAILED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the logs above for specific errors."
          echo ""
          echo "Common issues:"
          echo "  1. Parent POM not installed"
          echo "  2. Backend utils build failed"
          echo "  3. Missing dependencies"
          echo "  4. Compilation errors"
          echo ""
          echo "Troubleshooting:"
          echo "  - Check 'Install Parent POM' step"
          echo "  - Check 'Build Shared Backend Utils' step"
          echo "  - Look for Maven error messages"
          echo "  - Review pom.xml files for issues"
          echo ""
          exit 1
