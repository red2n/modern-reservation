server:
  port: 8080

spring:
  application:
    name: gateway-service
  config:
    import: "configserver:${CONFIG_SERVER_URL:http://localhost:8888}"
  cloud:
    config:
      username: ${CONFIG_SERVER_USERNAME:config-admin}
      password: ${CONFIG_SERVER_PASSWORD:#{null}}
      fail-fast: false
      retry:
        max-attempts: 6
        initial-interval: 1000
        max-interval: 2000
        multiplier: 1.1
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # Reservation Engine Routes
        - id: reservation-engine
          uri: lb://reservation-engine
          predicates:
            - Path=/api/v1/reservations/**
          filters:
            - name: CircuitBreaker
              args:
                name: reservation-circuit-breaker
                fallbackUri: forward:/fallback/reservation
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenish-rate: 10
                redis-rate-limiter.burst-capacity: 20
                redis-rate-limiter.requested-tokens: 1

        # Availability Calculator Routes
        - id: availability-calculator
          uri: lb://AVAILABILITY-CALCULATOR
          predicates:
            - Path=/api/v1/availability/**
          filters:
            - name: CircuitBreaker
              args:
                name: availability-circuit-breaker
                fallbackUri: forward:/fallback/availability
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenish-rate: 20
                redis-rate-limiter.burst-capacity: 40

        # Payment Processor Routes
        - id: payment-processor
          uri: lb://PAYMENT-PROCESSOR-SERVICE
          predicates:
            - Path=/api/v1/payments/**
          filters:
            - name: CircuitBreaker
              args:
                name: payment-circuit-breaker
                fallbackUri: forward:/fallback/payment
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenish-rate: 5
                redis-rate-limiter.burst-capacity: 10

        # Rate Management Routes
        - id: rate-management
          uri: lb://rate-management
          predicates:
            - Path=/api/v1/rates/**
          filters:
            - name: CircuitBreaker
              args:
                name: rate-circuit-breaker
                fallbackUri: forward:/fallback/rate

        # Analytics Engine Routes
        - id: analytics-engine
          uri: lb://analytics-engine
          predicates:
            - Path=/api/v1/analytics/**
          filters:
            - name: CircuitBreaker
              args:
                name: analytics-circuit-breaker
                fallbackUri: forward:/fallback/analytics

        # Tenant Service Routes (Infrastructure Service)
        - id: tenant-service
          uri: lb://tenant-service
          predicates:
            - Path=/api/tenants/**
          filters:
            - name: CircuitBreaker
              args:
                name: tenant-circuit-breaker
                fallbackUri: forward:/fallback/tenant

        # Batch Processor Routes
        - id: batch-processor
          uri: lb://batch-processor
          predicates:
            - Path=/api/v1/batch/**
          filters:
            - name: CircuitBreaker
              args:
                name: batch-circuit-breaker
                fallbackUri: forward:/fallback/batch

        # Service-Prefixed API Routes (for Swagger UI integration)
        # Note: No RewritePath needed - services have matching context-path configured
        - id: payment-processor-api
          uri: lb://PAYMENT-PROCESSOR-SERVICE
          order: -1
          predicates:
            - Path=/payment-processor/**

        - id: reservation-engine-api
          uri: lb://reservation-engine
          order: -1
          predicates:
            - Path=/reservation-engine/**

        - id: analytics-engine-api
          uri: lb://analytics-engine
          order: -1
          predicates:
            - Path=/analytics-engine/**

        - id: availability-calculator-api
          uri: lb://AVAILABILITY-CALCULATOR
          order: -1
          predicates:
            - Path=/availability-calculator/**

        - id: rate-management-api
          uri: lb://rate-management
          order: -1
          predicates:
            - Path=/rate-management/**

        - id: tenant-service-api
          uri: lb://tenant-service
          order: -1
          predicates:
            - Path=/tenant-service/**

        # Node.js Services Routes
        - id: api-gateway-node
          uri: lb://api-gateway-node
          predicates:
            - Path=/api/v1/graphql/**

        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/v1/notifications/**

        - id: websocket-service
          uri: lb://websocket-service
          predicates:
            - Path=/ws/**

        # Swagger UI Documentation Routes for Business Services
        # Note: These routes now pass through without rewriting since services have context-path
        - id: reservation-engine-docs
          uri: lb://reservation-engine
          order: -1
          predicates:
            - Path=/reservation-engine/api-docs/**

        - id: availability-calculator-docs
          uri: lb://AVAILABILITY-CALCULATOR
          order: -1
          predicates:
            - Path=/availability-calculator/api-docs/**

        - id: payment-processor-docs
          uri: lb://PAYMENT-PROCESSOR-SERVICE
          order: -1
          predicates:
            - Path=/payment-processor/api-docs/**

        - id: rate-management-docs
          uri: lb://RATE-MANAGEMENT
          order: -1
          predicates:
            - Path=/rate-management/api-docs/**

        - id: analytics-engine-docs
          uri: lb://analytics-engine
          order: -1
          predicates:
            - Path=/analytics-engine/api-docs/**

        - id: tenant-service-docs
          uri: lb://tenant-service
          order: -1
          predicates:
            - Path=/tenant-service/api-docs/**

        # Swagger UI Routes for Business Services
        # Note: No rewriting needed - services have matching context-path configured
        - id: availability-calculator-swagger-ui
          uri: lb://AVAILABILITY-CALCULATOR
          order: -1
          predicates:
            - Path=/availability-calculator/swagger-ui/**

        - id: payment-processor-swagger-ui
          uri: lb://PAYMENT-PROCESSOR-SERVICE
          order: -1
          predicates:
            - Path=/payment-processor/swagger-ui/**

        - id: rate-management-swagger-ui
          uri: lb://RATE-MANAGEMENT
          order: -1
          predicates:
            - Path=/rate-management/swagger-ui/**

        - id: analytics-engine-swagger-ui
          uri: lb://ANALYTICS-ENGINE
          order: -1
          predicates:
            - Path=/analytics-engine/swagger-ui/**

        - id: reservation-engine-swagger-ui
          uri: lb://RESERVATION-ENGINE
          order: -1
          predicates:
            - Path=/reservation-engine/swagger-ui/**

        - id: tenant-service-swagger-ui
          uri: lb://tenant-service
          order: -1
          predicates:
            - Path=/tenant-service/swagger-ui/**

  # Redis Configuration for Rate Limiting
  redis:
    host: localhost
    port: 6379
    timeout: 2000ms

  # Main Configuration
  main:
    allow-bean-definition-overriding: true
    web-application-type: reactive

# Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    instances:
      reservation-circuit-breaker:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        sliding-window-size: 10
        minimum-number-of-calls: 5
      availability-circuit-breaker:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        sliding-window-size: 10
        minimum-number-of-calls: 5
      payment-circuit-breaker:
        failure-rate-threshold: 30
        wait-duration-in-open-state: 15000
        sliding-window-size: 10
        minimum-number-of-calls: 3

# JWT Configuration
# CRITICAL: JWT_SECRET must be set as environment variable (minimum 256-bit)
# Generate secure secret: openssl rand -base64 32
jwt:
  secret: ${JWT_SECRET:#{null}}
  expiration: ${JWT_EXPIRATION:86400000} # 24 hours (default)
  issuer: ${JWT_ISSUER:modern-reservation-system}
  audience: ${JWT_AUDIENCE:modern-reservation-api}

# Management and Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway,circuitbreakers
  endpoint:
    health:
      show-details: always

# Logging Configuration
logging:
  level:
    com.modernreservation: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%X{traceId:-},%X{spanId:-}] [%thread] %-5level [%logger{36}] - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%X{traceId:-},%X{spanId:-}] [%thread] %-5level [%logger{36}] - %msg%n"
  file:
    name: ../../logs/infrastructure/gateway-service.log

# Application Information
info:
  app:
    name: Modern Reservation Gateway Service
    description: API Gateway with routing, load balancing, and security
    version: 2.0.0

# SpringDoc OpenAPI Configuration for Gateway
springdoc:
  api-docs:
    enabled: true
    path: /api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    config-url: /api-docs/swagger-config
    urls:
      - url: /api-docs
        name: Gateway Service
      - url: /tenant-service/api-docs
        name: üè¢ Tenant Service
      - url: /reservation-engine/api-docs
        name: üè® Reservation Engine
      - url: /availability-calculator/api-docs
        name: üìÖ Availability Calculator
      - url: /payment-processor/api-docs
        name: üí≥ Payment Processor
      - url: /rate-management/api-docs
        name: üí∞ Rate Management
      - url: /analytics-engine/api-docs
        name: üìä Analytics Engine
    urls-primary-name: Gateway Service
    display-request-duration: true
    groups-order: ASC
    operations-sorter: alpha
    tags-sorter: alpha
    disable-swagger-default-url: false
    show-extensions: true
    show-common-extensions: true
    deep-linking: true
    display-operation-id: false
    default-models-expand-depth: 1
    default-model-expand-depth: 1
    default-model-rendering: example
    doc-expansion: none
    filter: false
    oauth2-redirect-url: http://localhost:8080/swagger-ui/oauth2-redirect.html
  show-actuator: true
